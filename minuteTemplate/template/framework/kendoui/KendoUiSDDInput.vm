#exposeSeparator()
#putImportQuerySDDBean()
#putImportSDDInputBean()
#putImportQuerySDDBean()
#exposeQuerySpecific()
#exposeKendoUIModelSpecific()
#set($table=$inputBean)
#asUML($table)
#set ($inputClass = $commonUtils.getTemplateClassName($inputBean, $model, $templateSDDInputBean))
#set ($tableVariableName = $commonUtils.getJavaNameVariableFirstLetter($inputClass))
#set($tableDB = $inputBean)
#set ($entityControllerJSFClass = $commonUtils.getTemplateClassName($tableDB, $model, $templateEntityControllerJSF))
#set ($entityControllerJSFVariable = $commonUtils.getJavaNameVariableFirstLetter($entityControllerJSFClass))
#exposeVariableEntitySpecific()
#addedAreas()
<!DOCTYPE html>
<html>
<head>
<title></title>

#putKendoUIJSImport()

</head>

<body>
    
<div id="${tableVariableName}">
   <div>
   		<div id="form-${tableVariableName}" >
        	<h3>${tableVariableName}</h3>
<div style="display: table; width: 100%; margin-top: 10px;">
#*            
#foreach($column in $inputBean.columns)
#putColumnParams()
#columnJavaNaming()
#putKendoHtmlColumnSnippet($tableVariableName $tableVariableName)
#end
*#
<!-- pk -->
#foreach($column in ${table.primaryKeyColumns})
#putColumnParams()
#columnJavaNaming()
#if (!$isMany2Many && $isPkUserProvided)
#putKendoHtmlColumnSnippet($tableVariableName $tableVariableName)
#end
#end
#foreach ($columnGroup in $tableUtils.extractFieldGroup(${table.attributes}, $table))
#foreach ($column in $columnGroup)
#putColumnParams()
#columnJavaNaming()
#putKendoHtmlColumnSnippet($tableVariableName $tableVariableName)
#end
#end
<!-- reference -->
#foreach ($reference in $tableUtils.getParentOrderByReferenceData($table))
#putReferenceParams2()
#set ($column=$localColumn)
#putColumnParams()
#columnJavaNaming()
#putKendoHtmlColumnSnippet($tableVariableName $tableVariableName)
#end
</div>

            <!-- button action -->
            <p>
                <button id="action" class="k-button" data-bind="click: searchSdd">Execute</button>
            </p>
        </div>
    </div>
</div>

<div id="ssd-output-grid"/>
<div id="ssd-output-grid-popup"/>

<div id="details" />

<!-- kendo js scripts -->
<script>
    $(document).ready(function () {

	  //fields
#foreach($column in $inputBean.columns)
#if (!$column.hasBeenDuplicated())
#putColumnParams()
#columnJavaNaming()
#putKendoJsColumnSnippet($tableVariableName $tableVariableName)
#end
#end

## inspired by http://demos.telerik.com/kendo-ui/grid/custom-command
        wnd = $("#details").kendoWindow({
           title: "$className Details",
           modal: true,
           visible: false,
           resizable: false,
           width: 300
           }).data("kendoWindow");

        $("#ssd-output-grid-popup").kendoWindow({
            modal: true,
            resizable: true,
 			iframe: true
        }).data("kendoWindow");
            	
        detailsTemplate = kendo.template($("#template-detail").html());
#foreach ($column in $table.columns)
#if ($columnUtils.hasCheckConstraint($column))
#putColumnParamNaming()
#set($checkConstraints= $columnUtils.getCheckConstraintValues($column))
#set($size= $checkConstraints.size())
		var ${columnVar}List = [
#foreach ($property in $checkConstraints)
			{
				name : "$property.name",
				value : "$property.name"
			}
#if ($velocityCount!=$size)
            ,#end 
#end
		]
#end
#end
        var viewModel = kendo.observable({
#foreach ($column in $table.columns)
#if ($columnUtils.hasCheckConstraint($column))
#putColumnParamNaming()
			${columnVar}List : ${columnVar}List,
#end
#end
            searchSdd: function () {
                isQuestionMarkDone = false;
        		var query = "";
#set($cpt=0)
#foreach($column in $inputBean.columns)
#if (!$column.hasBeenDuplicated())
#set($cpt=$cpt+1)
#putColumnParamNaming()
        		var $columnVar = this.get("$columnVar");
#if($columnUtils.isTime($column))
                ${columnVar}Date = new Date(${columnVar});
				${columnVar}DateSt = kendo.toString(${columnVar}Date, "yyyy-MM-dd");
#set($columnValue="${columnVar}DateSt")
#else
#set($columnValue=$columnVar)
#end
                if ($columnVar!=undefined && !$columnVar=='') {
                    if (!isQuestionMarkDone) {
                        isQuestionMarkDone = true;
                        query = "?"+"$columnVar="+$columnValue;
                    } else {
                        query = query+"&"+"$columnVar="+$columnValue;
                    }
                }
#end
#end
				var dataSourceUrl = "/data/sdd/${tableClassName}In"+query;

                $("#ssd-output-grid").kendoGrid({
                    dataSource: {
                        transport: {
                            read: {
                                url: dataSourceUrl,
                                dataType: "json",
                                contentType: "application/json; charset=utf-8",
                                cache: false
                            }
                        }
                        ,
                        schema: {
                            data: "$sddOutputBeanClass"
                        }
                    },
##                    change: function () {
##						var rowId = this.select().data("uid");
##						var item = this.dataSource.getByUid(rowId);
##						kendo.ui.progress($("#ssd-output-grid"), true);
##						select4Info(item);
##					},
                    resizable: true,
                    sortable: {
                        mode: "single",
                        allowUnsort: false
                    },
                    pageable: {
                        buttonCount: 5
                    },
					columns: [
#foreach($column in $outputBean.columns)
#putColumnParamNaming()
					{
						//TODO hide
	                	field: "$columnVar",
	                	title: "$columnVar",
#updatedColumnAttributeAreas()
$!updatedAreaBegin
#if($isUpdated)
$updatedAreaSnippet
#else
//						width : toset,
#end
$!updatedAreaEnd
						hidden : false
	            	}
#if ($query.actions.size()>0 || $velocityCount!=$outputBean.columns.size())
                	,#end 
#end
#foreach ($action in $query.actions)
					{ command: { text: "$actionUtils.getActionLabel($action)", click: $actionUtils.getActionMethod($action) }, title: " ", width: "180px" }
#if ($velocityCount!=$query.actions.size())
                	,#end 
#end
	            	],
                    height: 500,
                    scrollable: true,
                    selectable: true

                });

            }

        });

#foreach ($field in $query.queryFields)
// is hidden $field.name $field.isHidden() $field.isKey() $field.value
#end
        kendo.bind($("#form-${tableVariableName}"), viewModel);

    });

	function openPopup(title, url, width, height) { 
		$("#ssd-output-grid-popup").html("");
		var popup = $("#ssd-output-grid-popup").data("kendoWindow");
		popup.wrapper.css({width: width, height: height});
		popup.title(true);
		popup.title(title);
		popup.refresh(url);

		// Patch for title of popup inside popups
		if (popup.wrapper.css("padding-bottom") == "0px") {
			popup.wrapper.css("padding-bottom", "10px");
		}

		popup.center().open();
	}
			
#foreach ($action in $query.actions)
	function $actionUtils.getActionMethod($action) (e) {
		e.preventDefault();
		var rowId = $("#ssd-output-grid").data("kendoGrid").select().data("uid");
		var item = $("#ssd-output-grid").data("kendoGrid").dataSource.getByUid(rowId);
##		kendo.ui.progress($("#ssd-output-grid"), true);
#exposeEntityUpdatedAreas("${action.name}-action")
$!updatedAreaBegin
#if($isUpdated)
$updatedAreaSnippet
#else
//		todo get url from query
#set($targetUrl = $actionUtils.getTargetUrl($action, $model))
		var targetUrl = "$targetUrl";
#foreach ($field in $query.queryFields)
#if ($field.isKey())
#set($fieldName=$field.name)
		var $fieldName = item.get("$fieldName");
		targetUrl = targetUrl +#if($velocityCount>1)"&"#else"?"#end +"$fieldName="+$fieldName;  
#end
#end

//			append parameters
//		if (target == single node 	=> popup)
//		if (target == list 			=> add list)
#end
		openPopup ("popup changeme",targetUrl, 1000, 600);
$!updatedAreaEnd
	}

#end
    function showDetails(e) {
       e.preventDefault();

       var dataItem = this.dataItem($(e.currentTarget).closest("tr"));
       wnd.content(detailsTemplate(dataItem));
       wnd.center().open();
   }

</script>

<script type="text/x-kendo-template" id="template-detail">
   <div id="details-container">
#foreach($column in $outputBean.columns)
#putColumnParamNaming()
       <h2>$columnVar : #= $columnVar # </h2>
#end
   </div>
</script>

</body>
</html>
